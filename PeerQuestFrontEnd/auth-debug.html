<!DOCTYPE html>
<html>
<head>
    <title>Auth Debug</title>
</head>
<body>
    <h1>Authentication Debug</h1>
    <div id="output"></div>
    
    <script>
        const output = document.getElementById('output');
        
        function log(message) {
            output.innerHTML += '<p>' + message + '</p>';
            console.log(message);
        }
        
        async function testAuth() {
            log('=== Authentication Test ===');
            
            // Check stored tokens
            const accessToken = localStorage.getItem('access_token');
            const refreshToken = localStorage.getItem('refresh_token');
            
            log('Access token exists: ' + !!accessToken);
            log('Refresh token exists: ' + !!refreshToken);
            
            if (accessToken) {
                log('Access token preview: ' + accessToken.substring(0, 20) + '...');
                
                // Try to decode JWT
                try {
                    const payload = JSON.parse(atob(accessToken.split('.')[1]));
                    const now = Math.floor(Date.now() / 1000);
                    log('Token user_id: ' + payload.user_id);
                    log('Token expires at: ' + new Date(payload.exp * 1000));
                    log('Token is valid: ' + (payload.exp > now));
                } catch (e) {
                    log('Failed to decode token: ' + e.message);
                }
                
                // Test API call
                try {
                    log('\\n=== Testing API Call ===');
                    const response = await fetch('http://127.0.0.1:8000/api/transactions/transactions/', {
                        headers: {
                            'Authorization': 'Bearer ' + accessToken,
                            'Content-Type': 'application/json',
                        },
                    });
                    
                    log('API Response status: ' + response.status + ' ' + response.statusText);
                    
                    if (response.ok) {
                        const data = await response.json();
                        log('API Response data: ' + JSON.stringify(data, null, 2));
                    } else {
                        const text = await response.text();
                        log('API Error response: ' + text);
                    }
                } catch (error) {
                    log('API call failed: ' + error.message);
                }
            } else {
                log('No access token found. Attempting login...');
                
                try {
                    const loginResponse = await fetch('http://127.0.0.1:8000/api/token/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            username: 'admin',
                            password: 'admin123'
                        }),
                    });
                    
                    if (loginResponse.ok) {
                        const loginData = await loginResponse.json();
                        localStorage.setItem('access_token', loginData.access);
                        localStorage.setItem('refresh_token', loginData.refresh);
                        log('Login successful! Tokens stored.');
                        log('You can now try the gold system modal.');
                    } else {
                        const errorText = await loginResponse.text();
                        log('Login failed: ' + errorText);
                    }
                } catch (error) {
                    log('Login request failed: ' + error.message);
                }
            }
        }
        
        // Run test on page load
        testAuth();
    </script>
    
    <button onclick="testAuth()">Run Test Again</button>
    <button onclick="localStorage.clear(); location.reload();">Clear Tokens & Reload</button>
</body>
</html>
